<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Now Playing on Plexamp</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2b2b2b;
            color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            flex-direction: column;
            position: relative;
        }
        .now-playing {
            text-align: center;
        }
        .now-playing img {
            border-radius: 10px;
            max-width: 300px;
            margin: 20px;
        }
        .progress-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .progress-bar {
            width: 300px;
            height: 10px;
            background-color: #444;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress {
            height: 100%;
            background-color: #00ff7f;
            width: 0;
            transition: width 0.1s linear; /* Smooth transition */
        }
        .time-info {
            display: flex;
            justify-content: space-between;
            width: 300px;
            margin-top: 5px;
            font-size: 14px;
        }
        /* Clock styles */
        #clock {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            background-color: #444;
            padding: 5px 10px;
            border-radius: 5px;
            color: #fff;
        }
    </style>
</head>
<body>
    <div id="clock"></div> <!-- Real-time clock -->
    
    <div class="now-playing">
        <h1>Now Playing on Plexamp</h1>
        <div id="track-info">
            <p>Loading...</p>
        </div>
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
            <div class="time-info">
                <span id="current-time">0:00</span>
                <span id="total-time">0:00</span>
            </div>
        </div>
    </div>

    <script>
        let currentOffset = 0;
        let totalDuration = 0;
        let lastUpdate = Date.now();
        let isPlaying = false;
        let lastMediaId = ''; // To check if media has changed

        // Function to format time (minutes:seconds)
        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        // Function to update the real-time clock
        function updateClock() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const currentTime = `${hours}:${minutes}:${seconds}`;
            document.getElementById('clock').innerText = currentTime;
        }

        // Update the clock every second
        setInterval(updateClock, 1000);
        updateClock(); // Call once to set immediately

        // Function to update the progress bar smoothly
        function updateProgressBar() {
            if (isPlaying) {
                const now = Date.now();
                const elapsedTime = now - lastUpdate;
                currentOffset += elapsedTime; // Increment progress locally
                lastUpdate = now;

                const progressPercentage = (currentOffset / totalDuration) * 100;
                document.getElementById('progress').style.width = progressPercentage + '%';
                document.getElementById('current-time').innerText = formatTime(currentOffset);

                if (currentOffset >= totalDuration) {
                    isPlaying = false; // Stop progress when song ends
                }
            }
        }

        // Call updateProgressBar every 200ms for smooth updates
        setInterval(updateProgressBar, 200);

        // Function to fetch "Now Playing" information from Plex
        async function fetchNowPlaying() {
            const plexToken = 'PLEXTOKEJ'; // Replace with your Plex token
            const plexIP = 'IPADRESS'; // Your Plex server IP
            const url = `http://${plexIP}:32400/status/sessions?X-Plex-Token=${plexToken}`;

            try {
                const response = await fetch(url);
                const data = await response.text(); // Plex API returns XML by default
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(data, "text/xml");

                let media = xmlDoc.querySelector("Video") || xmlDoc.querySelector("Track");

                if (media) {
                    const mediaId = media.getAttribute("ratingKey");
                    const title = media.getAttribute("title");
                    const artist = media.getAttribute("grandparentTitle") || media.getAttribute("parentTitle");
                    const coverUrl = media.getAttribute("thumb");
                    const newOffset = parseInt(media.getAttribute("viewOffset")) || 0;
                    const newDuration = parseInt(media.getAttribute("duration")) || 1;

                    // Sync progress only if media has changed or it's paused/seeked
                    if (mediaId !== lastMediaId || Math.abs(newOffset - currentOffset) > 2000) {
                        lastMediaId = mediaId;
                        currentOffset = newOffset;
                        totalDuration = newDuration;
                        lastUpdate = Date.now(); // Reset the update time
                    }

                    isPlaying = true;

                    const imageUrl = `http://${plexIP}:32400${coverUrl}?X-Plex-Token=${plexToken}`;
                    document.getElementById('track-info').innerHTML = `
                        <h2>${artist ? artist + ' - ' : ''}${title}</h2>
                        <img src="${imageUrl}" alt="${title}">
                    `;

                    document.getElementById('total-time').innerText = formatTime(totalDuration);
                } else {
                    document.getElementById('track-info').innerHTML = '<p>Nothing is currently playing.</p>';
                    document.getElementById('progress').style.width = '0%';
                    document.getElementById('current-time').innerText = '0:00';
                    document.getElementById('total-time').innerText = '0:00';
                    isPlaying = false;
                }
            } catch (error) {
                console.error('Error fetching now playing data:', error);
                document.getElementById('track-info').innerHTML = '<p>Error fetching data.</p>';
                document.getElementById('progress').style.width = '0%';
                document.getElementById('current-time').innerText = '0:00';
                document.getElementById('total-time').innerText = '0:00';
                isPlaying = false;
            }
        }

        // Fetch now playing info every 5 seconds
        setInterval(fetchNowPlaying, 5000);
        fetchNowPlaying(); // Initial call
    </script>
</body>
</html>
